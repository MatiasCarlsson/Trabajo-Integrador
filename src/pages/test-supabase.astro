---
// P√°gina de diagn√≥stico para verificar conexi√≥n con Supabase
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/db';

let connectionStatus = 'Conectando...';
let productCount = 0;
let error = null;
let sampleProducts = [];

try {
  // Intentar obtener el conteo de productos
  const { count, error: countError } = await supabase
    .from('productos')
    .select('*', { count: 'exact', head: true });

  if (countError) throw countError;

  productCount = count || 0;

  // Obtener 3 productos de muestra
  const { data, error: dataError } = await supabase
    .from('productos')
    .select('id, nombre, precio, puntos')
    .limit(3);

  if (dataError) throw dataError;

  sampleProducts = data || [];
  connectionStatus = '‚úÖ Conectado exitosamente a Supabase';
} catch (e) {
  connectionStatus = '‚ùå Error de conexi√≥n';
  error = e instanceof Error ? e.message : 'Error desconocido';
}
---

<Layout title="Test Supabase Connection">
  <main class="container mx-auto px-4 py-8">
    <h1 class="mb-6 text-3xl font-bold">üîç Diagn√≥stico de Conexi√≥n Supabase</h1>

    <div
      class={`p-6 rounded-lg mb-6 ${error ? 'bg-red-100 border-2 border-red-500' : 'bg-green-100 border-2 border-green-500'}`}
    >
      <h2 class="mb-2 text-xl font-semibold">Estado de Conexi√≥n:</h2>
      <p class="text-lg">{connectionStatus}</p>
    </div>

    {
      error ? (
        <div class="mb-6 rounded-lg border border-red-300 bg-red-50 p-4">
          <h3 class="mb-2 text-lg font-semibold text-red-700">Error:</h3>
          <code class="text-sm text-red-600">{error}</code>
        </div>
      ) : (
        <>
          <div class="mb-6 rounded-lg border border-blue-300 bg-blue-50 p-6">
            <h3 class="mb-2 text-xl font-semibold">üìä Estad√≠sticas:</h3>
            <p class="text-lg">
              Total de productos en la base de datos:{' '}
              <strong class="text-blue-600">{productCount}</strong>
            </p>
          </div>

          {sampleProducts.length > 0 && (
            <div class="rounded-lg border border-gray-300 bg-gray-50 p-6">
              <h3 class="mb-4 text-xl font-semibold">
                üéØ Productos de muestra:
              </h3>
              <div class="space-y-3">
                {sampleProducts.map((producto) => (
                  <div class="rounded border border-gray-200 bg-white p-4 shadow-sm">
                    <p>
                      <strong>ID:</strong> {producto.id}
                    </p>
                    <p>
                      <strong>Nombre:</strong> {producto.nombre}
                    </p>
                    <p>
                      <strong>Precio:</strong> ${producto.precio}
                    </p>
                    <p>
                      <strong>Puntos:</strong> {producto.puntos}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          )}
        </>
      )
    }

    <div class="mt-8 rounded-lg bg-gray-100 p-4">
      <h3 class="mb-2 font-semibold">‚ÑπÔ∏è Informaci√≥n del entorno:</h3>
      <ul class="space-y-1 text-sm">
        <li>
          <strong>Supabase URL:</strong>
          <code class="rounded bg-gray-200 px-2 py-1"
            >{import.meta.env.PUBLIC_SUPABASE_URL || 'NO CONFIGURADO'}</code>
        </li>
        <li>
          <strong>Anon Key configurada:</strong>
          {import.meta.env.PUBLIC_SUPABASE_ANON_KEY ? '‚úÖ S√≠' : '‚ùå No'}
        </li>
        <li><strong>Modo:</strong> {import.meta.env.MODE}</li>
        <li><strong>Prod:</strong> {import.meta.env.PROD ? 'S√≠' : 'No'}</li>
      </ul>
    </div>

    <div class="mt-6">
      <a href="/" class="text-blue-600 hover:underline">‚Üê Volver al inicio</a>
    </div>
  </main>
</Layout>
